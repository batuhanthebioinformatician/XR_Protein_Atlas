<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>XR Protein Atlas Viewer (3Dmol.js)</title>
  <!-- use latest build -->
  <script src="https://3dmol.org/build/3Dmol-min.js?v=latest"></script>
  <style>
    body{margin:0;font-family:Arial, sans-serif;background:#0b0e14;color:#e6edf3}
    header{padding:10px;background:#121826;display:flex;flex-direction:column;gap:10px}
    header h1{font-size:18px;margin:0}
    #controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    #clusterButtons{display:flex;flex-wrap:wrap;gap:5px;margin-top:5px}
    #viewer{width:100%;height:75vh;position:relative}
    #metadata{padding:10px;background:#121826;min-height:15vh}
    input,button{padding:6px 10px;border-radius:6px;border:1px solid #2b3648;background:#1f2937;color:#e6edf3}
    button:hover{background:#2b3648;cursor:pointer}
    /* floating tooltip */
    #tooltip{
      position:fixed; display:none; z-index:9999;
      background:rgba(0,0,0,.85); color:#fff; padding:4px 6px; border-radius:4px; font-size:12px;
      pointer-events:none
    }
  </style>
</head>
<body>
  <header>
    <h1>XR Protein Atlas Viewer (3Dmol.js)</h1>
    <div id="controls">
      <button id="prevBtn">◀ Prev</button>
      <button id="nextBtn">Next ▶</button>
      <input id="searchBox" type="text" placeholder="Search by ID or cluster" />
      <button id="searchBtn">Search</button>
    </div>
    <div id="clusterButtons"></div>
  </header>

  <div id="viewer"></div>
  <div id="tooltip"></div>

  <div id="metadata">
    <strong>ID:</strong> <span id="meta-id"></span><br/>
    <strong>Cluster:</strong> <span id="meta-cluster"></span><br/>
    <strong>Type:</strong> <span id="meta-type"></span>
  </div>

  <script>
    /* === Your protein list (kept as you pasted) === */
    let proteins = [
      { id: "BDU10525.1", cluster: -1 },
      { id: "PSQ71425.1", cluster: -1 },
      { id: "KGA09086.1", cluster: -1 },
      { id: "RZP28624.1", cluster: -1 },
      { id: "PQM62056.1", cluster: -1 },
      { id: "TEX51253.1", cluster: -1 },
      { id: "BDS50908.1", cluster: -1 },
      { id: "BDS48601.1", cluster: -1 },
      { id: "PSQ75764.1", cluster: -1 },
      { id: "KRO48502.1", cluster: -1 },
      { id: "GDX15377.1", cluster: -1 },
      { id: "OZ244400.1", cluster: -1 },
      { id: "CP175953.1", cluster: -1 },
      { id: "GIK75739.1", cluster: -1 },
      { id: "GIJ78539.1", cluster: -1 },
      { id: "GGL78780.1", cluster: -1 },
      { id: "GGD58117.1", cluster: -1 },
      { id: "BDP99755.1", cluster: -1 },
      { id: "OZ243888.1", cluster: -1 },
      { id: "VIP02740.1", cluster: -1 },
      { id: "OY829846.1", cluster: -1 },
      { id: "PTM12582.1", cluster: -1 },
      { id: "PDH56100.1", cluster: -1 },
      { id: "RPF79760.1", cluster: -1 },
      { id: "RCL66720.1", cluster: -1 },
      { id: "TVR90991.1", cluster: -1 },
      { id: "GDX68660.1", cluster: -1 },
      { id: "RLT23870.1", cluster: -1 },
      { id: "CP030884.1", cluster: -1 },
      { id: "RMF54189.1", cluster: -1 },
      { id: "OZ252252.1", cluster: -1 },
      { id: "PSN19400.1", cluster: -1 },
      { id: "TVR25957.1", cluster: -1 },
      { id: "RDI95066.1", cluster: -1 },
      { id: "GLV48970.1", cluster: -1 },
      { id: "RLT17137.1", cluster: -1 },
      { id: "RLS66247.1", cluster: -1 },
      { id: "PNY79880.1", cluster: -1 },
      { id: "BDP42045.1", cluster: -1 },
      { id: "GIR74196.1", cluster: 0 },
      { id: "CP121331.1", cluster: 0 },
      { id: "OZ244580.1", cluster: 0 },
      { id: "GIR98463.1", cluster: 0 },
      { id: "GDX66558.1", cluster: 0 },
      { id: "GDX64887.1", cluster: 0 },
      { id: "GDX48447.1", cluster: 0 },
      { id: "OZ245751.1", cluster: 0 },
      { id: "GDX44761.1", cluster: 0 },
      { id: "OX044355.1", cluster: 0 },
      { id: "OZ245931.1", cluster: 0 },
      { id: "OZ245839.1", cluster: 0 },
      { id: "OZ252014.1", cluster: 0 },
      { id: "OZ245756.1", cluster: 0 },
      { id: "OZ243102.1", cluster: 0 },
      { id: "OZ245746.1", cluster: 0 },
      { id: "OY829375.1", cluster: 0 },
      { id: "GIR21845.1", cluster: 0 },
      { id: "OX044357.1", cluster: 0 },
      { id: "OZ244159.1", cluster: 0 },
      { id: "OZ245719.1", cluster: 0 },
      { id: "GGD16574.1", cluster: 0 },
      { id: "CP136574.1", cluster: 0 },
      { id: "OZ245731.1", cluster: 0 },
      { id: "CP073016.1", cluster: 0 },
      { id: "GGH88435.1", cluster: 0 },
      { id: "GGF73035.1", cluster: 0 },
      { id: "GCD77160.1", cluster: 0 },
      { id: "BDD16568.1", cluster: 0 },
      { id: "OX044356.1", cluster: 0 },
      { id: "GCD80454.1", cluster: 0 },
      { id: "GGC30146.1", cluster: 0 },
      { id: "OX044362.1", cluster: 0 },
      { id: "OZ252262.1", cluster: 0 },
      { id: "OZ245886.1", cluster: 0 },
      { id: "OY829281.1", cluster: 0 },
      { id: "OZ243096.1", cluster: 0 },
      { id: "GHB23597.1", cluster: 0 },
      { id: "CP121312.1", cluster: 0 },
      { id: "GGB53743.1", cluster: 1 },
      { id: "OYY97977.1", cluster: 1 },
      { id: "OYY69292.1", cluster: 1 },
      { id: "PBN43411.1", cluster: 1 },
      { id: "OHC98024.1", cluster: 1 },
      { id: "OHD05260.1", cluster: 1 },
      { id: "EXS71053.1", cluster: 1 },
      { id: "OYZ61278.1", cluster: 1 },
      { id: "AOF96519.1", cluster: 1 },
      { id: "OZA83208.1", cluster: 1 },
      { id: "RFU11683.1", cluster: 1 },
      { id: "OAN57215.1", cluster: 1 },
      { id: "KTF68840.1", cluster: 1 },
      { id: "PVX30487.1", cluster: 1 },
      { id: "CP136575.1", cluster: 1 },
      { id: "KPF93223.1", cluster: 1 },
      { id: "KKC31033.1", cluster: 1 },
      { id: "KIN73522.1", cluster: 1 },
      { id: "GGD04646.1", cluster: 1 },
      { id: "SN06pond07", cluster: 1 },
      { id: "PIX67554.1", cluster: 1 },
      { id: "RRQ51041.1", cluster: 1 },
      { id: "PZN99150.1", cluster: 1 },
      { id: "KQM62812.1", cluster: 1 },
      { id: "OZ252211.1", cluster: 1 },
      { id: "L1DT4B", cluster: 1 },
      { id: "L1BD2", cluster: 1 },
      { id: "VOU06NAS01", cluster: 1 },
      { id: "PJK06NCP03", cluster: 1 },
      { id: "VVT24364.1", cluster: 1 },
      { id: "OYX57372.1", cluster: 1 },
      { id: "S2H28", cluster: 1 },
      { id: "9OR8", cluster: 1 },
      { id: "JWL2", cluster: 1 },
      { id: "JOBD13", cluster: 1 },
      { id: "BCA61338.1", cluster: 1 },
      { id: "GGE22526.1", cluster: 1 },
      { id: "JPL28", cluster: 1 },
      { id: "KQN28516.1", cluster: 1 },
      { id: "RXD06694.1", cluster: 1 },
      { id: "PZO76000.1", cluster: 1 },
      { id: "S3H21", cluster: 1 },
      { id: "GGE78254.1", cluster: 1 },
      { id: "OYX73886.1", cluster: 1 },
      { id: "OYW29954.1", cluster: 1 },
      { id: "PZO09322.1", cluster: 1 },
      { id: "EDP63929.1", cluster: 1 },
      { id: "TVS12205.1", cluster: 1 },
      { id: "TVQ33031.1", cluster: 1 },
      { id: "26OR1", cluster: 1 },
      { id: "GGA49527.1", cluster: 1 },
      { id: "KQN08864.1", cluster: 1 },
      { id: "JOOD22", cluster: 1 },
      { id: "BCA60302.1", cluster: 1 },
      { id: "TJZ84602.1", cluster: 1 },
      { id: "ODT58092.1", cluster: 1 },
      { id: "TGN61835.1", cluster: 1 },
      { id: "M1U20", cluster: 1 },
      { id: "J1U1", cluster: 1 },
      { id: "SKI02AP11", cluster: 1 },
      { id: "MTK02EP03", cluster: 1 },
      { id: "QBM75193.1", cluster: 1 },
      { id: "GHH23836.1", cluster: 1 },
      { id: "SKI02CP10", cluster: 1 },
      { id: "SKI02AS03", cluster: 1 },
      { id: "TPG52660.1", cluster: 1 },
      { id: "LKI02BS01", cluster: 1 },
      { id: "TPG09633.1", cluster: 1 },
      { id: "OYX52601.1", cluster: 1 },
      { id: "RYD68531.1", cluster: 1 },
      { id: "AHE52940.1", cluster: 1 },
      { id: "SSN206AS01", cluster: 1 },
      { id: "L1BT3", cluster: 1 },
      { id: "POU06NBS01", cluster: 1 },
      { id: "POU06NCP01", cluster: 1 },
      { id: "L1CD2B", cluster: 1 },
      { id: "KQM73760.1", cluster: 1 },
      { id: "PND56870.1", cluster: 2 },
      { id: "KQP67191.1", cluster: 2 },
      { id: "KAA0928310.1", cluster: 2 },
      { id: "BBX67830.1", cluster: 2 },
      { id: "GGF14204.1", cluster: 2 },
      { id: "OJY43810.1", cluster: 2 },
      { id: "KQQ42193.1", cluster: 2 },
      { id: "TVS86872.1", cluster: 2 },
      { id: "BDX33020.1", cluster: 2 },
      { id: "GLP76198.1", cluster: 2 },
      { id: "TPG37408.1", cluster: 2 },
      { id: "OFE15031.1", cluster: 2 },
      { id: "GDX33038.1", cluster: 2 },
      { id: "GDX17393.1", cluster: 2 },
      { id: "KQY09766.1", cluster: 2 },
      { id: "PVE17425.1", cluster: 2 },
      { id: "PHX60469.1", cluster: 2 },
      { id: "PPB45911.1", cluster: 2 },
      { id: "GGF92574.1", cluster: 2 },
      { id: "POH71228.1", cluster: 2 },
      { id: "POH64568.1", cluster: 2 },
      { id: "ASD22500.1", cluster: 2 },
      { id: "TPV25452.1", cluster: 2 },
      { id: "TFD93427.1", cluster: 2 },
      { id: "PXA72408.1", cluster: 2 },
      { id: "ANP74617.1", cluster: 2 },
      { id: "TFC17038.1", cluster: 2 },
      { id: "TFB96360.1", cluster: 2 },
      { id: "TFB90653.1", cluster: 2 },
      { id: "OZE29894.1", cluster: 2 },
      { id: "RFA24929.1", cluster: 2 },
      { id: "RFA18018.1", cluster: 2 },
      { id: "RFA12328.1", cluster: 2 },
      { id: "PPF85931.1", cluster: 2 },
      { id: "AWG02835.1", cluster: 2 },
      { id: "AJW80239.1", cluster: 2 },
      { id: "TFC16264.1", cluster: 2 },
      { id: "QHO71000.1", cluster: 2 },
      { id: "AZI59391.1", cluster: 2 },
      { id: "TIH31229.1", cluster: 2 },
      { id: "GGL05201.1", cluster: 2 },
      { id: "KAA9111499.1", cluster: 2 },
      { id: "RFA18400.1", cluster: 2 },
      { id: "OZE95541.1", cluster: 2 },
      { id: "TFB99530.1", cluster: 2 },
      { id: "TFC80037.1", cluster: 2 },
      { id: "TFC85940.1", cluster: 2 },
      { id: "TFC91058.1", cluster: 2 },
      { id: "TFC31694.1", cluster: 2 },
      { id: "TFB54523.1", cluster: 2 },
      { id: "OUM42966.1", cluster: 2 },
      { id: "TFC80606.1", cluster: 2 },
      { id: "TFD76797.1", cluster: 2 },
      { id: "TFD76712.1", cluster: 2 },
      { id: "TFD28381.1", cluster: 2 },
      { id: "TFB81715.1", cluster: 2 },
      { id: "TFD08492.1", cluster: 2 },
      { id: "TFD24290.1", cluster: 2 },
      { id: "TFC25459.1", cluster: 2 },
      { id: "PPB48466.1", cluster: 2 },
      { id: "TFD85230.1", cluster: 2 },
      { id: "RJT90601.1", cluster: 2 },
      { id: "TFB89747.1", cluster: 2 },
      { id: "KRO49903.1", cluster: 3 },
      { id: "KRO51529.1", cluster: 3 },
      { id: "TSA20550.1", cluster: 3 },
      { id: "GDX21556.1", cluster: 3 },
      { id: "TRZ73044.1", cluster: 3 },
      { id: "QLL25445.1", cluster: 3 },
      { id: "QLL24047.1", cluster: 3 },
      { id: "KRO36646.1", cluster: 3 },
      { id: "KRO30341.1", cluster: 3 },
      { id: "GDX24649.1", cluster: 3 },
      { id: "GDX22696.1", cluster: 3 },
      { id: "GDX16682.1", cluster: 3 },
      { id: "PHX75877.1", cluster: 3 },
      { id: "RMH64933.1", cluster: 4 },
      { id: "PSQ94854.1", cluster: 4 },
      { id: "PQJ33473.1", cluster: 4 },
      { id: "PSQ94898.1", cluster: 4 },
      { id: "PSQ65031.1", cluster: 4 },
      { id: "PSQ66410.1", cluster: 4 },
      { id: "PEN15075.1", cluster: 4 },
      { id: "PSQ95756.1", cluster: 4 },
      { id: "PJF31817.1", cluster: 4 },
      { id: "RZM77228.1", cluster: 5 },
      { id: "TVP63961.1", cluster: 5 },
      { id: "ESA36503.1", cluster: 5 },
      { id: "GGJ70114.1", cluster: 5 },
      { id: "GGR19346.1", cluster: 5 },
      { id: "OZ252009.1", cluster: 5 },
      { id: "ANE44876.1", cluster: 5 },
      { id: "PJF35373.1", cluster: 5 },
      { id: "OZ252036.1", cluster: 5 },
      // Experimental CIF
      { id: "Kin4B8", cluster: 1, format: "cif", experimental: true },
      { id: "ABC44767.1", cluster: 4, format: "cif", experimental: true }
    ];

    let conservedResidues = {
  "ABC44767.1": { gly: 156, lys: 240 },
  "OZ243888.1": { gly: 152, lys: 236 },
  "GDX15377.1": { gly: 144, lys: 232 },
  "KRO48502.1": { gly: 145, lys: 225 },
  "BDP99755.1": { gly: 152, lys: 232 },
  "BDU10525.1": { gly: 160, lys: 240 },
  "BDS50908.1": { gly: 151, lys: 234 },
  "BDS48601.1": { gly: 151, lys: 231 },
  "KGA09086.1": { gly: 152, lys: 238 },
  "RZP28624.1": { gly: 138, lys: 217 },
  "PQM62056.1": { gly: 138, lys: 217 },
  "TEX51253.1": { gly: 135, lys: 214 },
  "BDP42045.1": { gly: 153, lys: 232 },
  "PSQ71425.1": { gly: 161, lys: 240 },
  "PSQ75764.1": { gly: 160, lys: 239 },
  "VIP02740.1": { gly: 155, lys: 244 },
  "CP030884.1": { gly: 162, lys: 250 },
  "OY829846.1": { gly: 162, lys: 250 },
  "RLT17137.1": { gly: 152, lys: 240 },
  "RLS66247.1": { gly: 152, lys: 240 },
  "RDI95066.1": { gly: 157, lys: 236 },
  "GLV48970.1": { gly: 152, lys: 233 },
  "GDX68660.1": { gly: 148, lys: 227 },
  "RMF54189.1": { gly: 149, lys: 231 },
  "TVR25957.1": { gly: 138, lys: 217 },
  "Kin4B8": { gly: 153, lys: 233 },
  "RLT23870.1": { gly: 153, lys: 232 },
  "RPF79760.1": { gly: 154, lys: 233 },
  "RCL66720.1": { gly: 154, lys: 233 },
  "PTM12582.1": { gly: 153, lys: 232 },
  "PDH56100.1": { gly: 152, lys: 231 },
  "PSN19400.1": { gly: 99, lys: 178 },
  "TVR90991.1": { gly: 150, lys: 229 },
  "OZ252252.1": { gly: 175, lys: 255 },
  "PNY79880.1": { gly: 170, lys: 251 },
  "GGD58117.1": { gly: 171, lys: 249 },
  "GIJ78539.1": { gly: 156, lys: 234 },
  "GGL78780.1": { gly: 156, lys: 234 },
  "GIK75739.1": { gly: 161, lys: 239 },
  "OZ244400.1": { gly: 170, lys: 254 },
  "CP175953.1": { gly: 174, lys: 259 },
  "GIR74196.1": { gly: 149, lys: 227 },
  "GIR21845.1": { gly: 135, lys: 225 },
  "OY829375.1": { gly: 138, lys: 221 },
  "OZ245746.1": { gly: 138, lys: 221 },
  "OZ243102.1": { gly: 138, lys: 221 },
  "OZ245839.1": { gly: 138, lys: 221 },
  "OZ252014.1": { gly: 138, lys: 221 },
  "OZ245756.1": { gly: 138, lys: 221 },
  "OZ245931.1": { gly: 144, lys: 226 },
  "OZ245719.1": { gly: 144, lys: 226 },
  "OZ245751.1": { gly: 144, lys: 226 },
  "GDX44761.1": { gly: 144, lys: 226 },
  "GDX48447.1": { gly: 135, lys: 223 },
  "GDX66558.1": { gly: 139, lys: 227 },
  "GDX64887.1": { gly: 139, lys: 227 },
  "GIR98463.1": { gly: 143, lys: 226 },
  "OZ244580.1": { gly: 141, lys: 223 },
  "OX044355.1": { gly: 178, lys: 261 },
  "OZ244159.1": { gly: 143, lys: 224 },
  "GGD16574.1": { gly: 143, lys: 225 },
  "CP136574.1": { gly: 143, lys: 224 },
  "OZ243096.1": { gly: 140, lys: 219 },
  "CP121312.1": { gly: 140, lys: 219 },
  "OY829281.1": { gly: 140, lys: 219 },
  "OZ252262.1": { gly: 143, lys: 222 },
  "OZ245886.1": { gly: 140, lys: 219 },
  "OX044362.1": { gly: 144, lys: 226 },
  "GGC30146.1": { gly: 144, lys: 226 },
  "GHB23597.1": { gly: 144, lys: 226 },
  "OX044356.1": { gly: 149, lys: 232 },
  "BDD16568.1": { gly: 144, lys: 230 },
  "GCD77160.1": { gly: 154, lys: 238 },
  "GCD80454.1": { gly: 145, lys: 229 },
  "GGH88435.1": { gly: 145, lys: 229 },
  "GGF73035.1": { gly: 144, lys: 228 },
  "CP073016.1": { gly: 143, lys: 227 },
  "OZ245731.1": { gly: 144, lys: 228 },
  "CP121331.1": { gly: 141, lys: 225 },
  "OX044357.1": { gly: 143, lys: 227 },
  "TVS12205.1": { gly: 150, lys: 230 },
  "TVQ33031.1": { gly: 150, lys: 230 },
  "PZO09322.1": { gly: 150, lys: 230 },
  "EDP63929.1": { gly: 150, lys: 230 },
  "OYX73886.1": { gly: 149, lys: 228 },
  "OYW29954.1": { gly: 149, lys: 228 },
  "GGE78254.1": { gly: 162, lys: 241 },
  "S3H21": { gly: 149, lys: 228 },
  "RXD06694.1": { gly: 149, lys: 228 },
  "PZO76000.1": { gly: 149, lys: 228 },
  "KQN28516.1": { gly: 149, lys: 228 },
  "JPL28": { gly: 149, lys: 228 },
  "26OR1": { gly: 149, lys: 228 },
  "BCA61338.1": { gly: 149, lys: 228 },
  "JWL2": { gly: 149, lys: 228 },
  "JOBD13": { gly: 149, lys: 228 },
  "S2H28": { gly: 149, lys: 228 },
  "9OR8": { gly: 149, lys: 228 },
  "L1DT4B": { gly: 149, lys: 228 },
  "L1BD2": { gly: 149, lys: 228 },
  "VOU06NAS01": { gly: 149, lys: 228 },
  "PJK06NCP03": { gly: 149, lys: 228 },
  "VVT24364.1": { gly: 149, lys: 228 },
  "KQN08864.1": { gly: 149, lys: 228 },
  "GGE22526.1": { gly: 149, lys: 228 },
  "GGA49527.1": { gly: 149, lys: 228 },
  "SKI02AP11": { gly: 201, lys: 280 },
  "JOOD22": { gly: 149, lys: 228 },
  "LKI02BS01": { gly: 149, lys: 228 },
  "OYX52601.1": { gly: 149, lys: 228 },
  "RYD68531.1": { gly: 149, lys: 228 },
  "AHE52940.1": { gly: 149, lys: 228 },
  "SSN206AS01": { gly: 149, lys: 228 },
  "L1BT3": { gly: 149, lys: 228 },
  "POU06NBS01": { gly: 149, lys: 228 },
  "POU06NCP01": { gly: 149, lys: 228 },
  "KQM73760.1": { gly: 149, lys: 228 },
  "L1CD2B": { gly: 149, lys: 228 },
  "KQM62812.1": { gly: 149, lys: 228 },
  "TPG09633.1": { gly: 149, lys: 228 },
  "SKI02CP10": { gly: 149, lys: 228 },
  "SKI02AS03": { gly: 149, lys: 228 },
  "QBM75193.1": { gly: 149, lys: 228 },
  "GHH23836.1": { gly: 149, lys: 228 },
  "MTK02EP03": { gly: 149, lys: 228 },
  "TPG52660.1": { gly: 149, lys: 228 },
  "M1U20": { gly: 149, lys: 228 },
  "J1U1": { gly: 149, lys: 228 },
  "TGN61835.1": { gly: 158, lys: 237 },
  "TJZ84602.1": { gly: 158, lys: 237 },
  "ODT58092.1": { gly: 158, lys: 237 },
  "OZ252211.1": { gly: 149, lys: 228 },
  "BCA60302.1": { gly: 149, lys: 228 },
  "PZN99150.1": { gly: 149, lys: 228 },
  "OYX57372.1": { gly: 149, lys: 228 },
  "PIX67554.1": { gly: 149, lys: 228 },
  "GGB53743.1": { gly: 149, lys: 228 },
  "OHC98024.1": { gly: 152, lys: 231 },
  "OHD05260.1": { gly: 149, lys: 228 },
  "EXS71053.1": { gly: 149, lys: 228 },
  "PBN43411.1": { gly: 149, lys: 228 },
  "AOF96519.1": { gly: 149, lys: 228 },
  "OYY69292.1": { gly: 149, lys: 228 },
  "OYY97977.1": { gly: 149, lys: 228 },
  "OYZ61278.1": { gly: 149, lys: 228 },
  "OZA83208.1": { gly: 149, lys: 228 },
  "RRQ51041.1": { gly: 149, lys: 228 },
  "OAN57215.1": { gly: 151, lys: 230 },
  "KTF68840.1": { gly: 151, lys: 230 },
  "PVX30487.1": { gly: 151, lys: 230 },
  "CP136575.1": { gly: 149, lys: 228 },
  "KPF93223.1": { gly: 149, lys: 228 },
  "KKC31033.1": { gly: 149, lys: 228 },
  "RFU11683.1": { gly: 149, lys: 228 },
  "KIN73522.1": { gly: 149, lys: 228 },
  "GGD04646.1": { gly: 149, lys: 228 },
  "SN06pond07": { gly: 149, lys: 228 },
  "OFE15031.1": { gly: 160, lys: 242 },
  "KAA9111499.1": { gly: 156, lys: 234 },
  "GGL05201.1": { gly: 156, lys: 235 },
  "TIH31229.1": { gly: 155, lys: 234 },
  "AZI59391.1": { gly: 155, lys: 234 },
  "QHO71000.1": { gly: 156, lys: 235 },
  "TFC16264.1": { gly: 156, lys: 235 },
  "PPF85931.1": { gly: 156, lys: 235 },
  "AWG02835.1": { gly: 156, lys: 235 },
  "AJW80239.1": { gly: 156, lys: 235 },
  "RFA24929.1": { gly: 156, lys: 235 },
  "RFA18018.1": { gly: 156, lys: 235 },
  "RFA18400.1": { gly: 156, lys: 235 },
  "RFA12328.1": { gly: 156, lys: 235 },
  "TFB90653.1": { gly: 156, lys: 235 },
  "TFC17038.1": { gly: 156, lys: 235 },
  "TFB96360.1": { gly: 156, lys: 235 },
  "ANP74617.1": { gly: 156, lys: 235 },
  "POH71228.1": { gly: 156, lys: 235 },
  "POH64568.1": { gly: 156, lys: 235 },
  "ASD22500.1": { gly: 156, lys: 235 },
  "TFB99530.1": { gly: 156, lys: 235 },
  "TFD93427.1": { gly: 156, lys: 235 },
  "PXA72408.1": { gly: 155, lys: 234 },
  "GGF92574.1": { gly: 156, lys: 235 },
  "OZE29894.1": { gly: 156, lys: 235 },
  "OZE95541.1": { gly: 156, lys: 235 },
  "RJT90601.1": { gly: 156, lys: 235 },
  "TFD85230.1": { gly: 156, lys: 235 },
  "TFC25459.1": { gly: 156, lys: 235 },
  "TFB89747.1": { gly: 156, lys: 235 },
  "TFD24290.1": { gly: 156, lys: 235 },
  "TFB81715.1": { gly: 156, lys: 235 },
  "TFD08492.1": { gly: 156, lys: 235 },
  "TFC80037.1": { gly: 156, lys: 235 },
  "TFD76797.1": { gly: 155, lys: 234 },
  "TFD76712.1": { gly: 156, lys: 235 },
  "TFC80606.1": { gly: 140, lys: 219 },
  "TFC31694.1": { gly: 156, lys: 235 },
  "TFB54523.1": { gly: 156, lys: 235 },
  "TFC85940.1": { gly: 156, lys: 235 },
  "TFC91058.1": { gly: 140, lys: 219 },
  "TFD28381.1": { gly: 140, lys: 219 },
  "PPB48466.1": { gly: 156, lys: 235 },
  "PVE17425.1": { gly: 156, lys: 235 },
  "PPB45911.1": { gly: 156, lys: 235 },
  "TPV25452.1": { gly: 156, lys: 235 },
  "OUM42966.1": { gly: 156, lys: 235 },
  "TVS86872.1": { gly: 156, lys: 236 },
  "BBX67830.1": { gly: 156, lys: 235 },
  "PND56870.1": { gly: 156, lys: 236 },
  "KAA0928310.1": { gly: 156, lys: 236 },
  "GGF14204.1": { gly: 156, lys: 235 },
  "OJY43810.1": { gly: 156, lys: 235 },
  "KQP67191.1": { gly: 155, lys: 234 },
  "KQQ42193.1": { gly: 155, lys: 234 },
  "KQY09766.1": { gly: 156, lys: 235 },
  "BDX33020.1": { gly: 156, lys: 235 },
  "GLP76198.1": { gly: 156, lys: 235 },
  "TPG37408.1": { gly: 155, lys: 234 },
  "GDX17393.1": { gly: 155, lys: 241 },
  "GDX33038.1": { gly: 162, lys: 241 },
  "PHX60469.1": { gly: 162, lys: 241 },
  "PHX75877.1": { gly: 149, lys: 233 },
  "GDX16682.1": { gly: 148, lys: 227 },
  "GDX22696.1": { gly: 135, lys: 214 },
  "KRO36646.1": { gly: 148, lys: 227 },
  "QLL24047.1": { gly: 150, lys: 229 },
  "QLL25445.1": { gly: 149, lys: 229 },
  "TRZ73044.1": { gly: 148, lys: 228 },
  "GDX24649.1": { gly: 151, lys: 230 },
  "GDX21556.1": { gly: 149, lys: 228 },
  "KRO30341.1": { gly: 154, lys: 236 },
  "KRO49903.1": { gly: 151, lys: 232 },
  "KRO51529.1": { gly: 151, lys: 232 },
  "TSA20550.1": { gly: 135, lys: 217 },
  "PJF31817.1": { gly: 151, lys: 233 },
  "RMH64933.1": { gly: 149, lys: 228 },
  "PEN15075.1": { gly: 157, lys: 240 },
  "PSQ94854.1": { gly: 158, lys: 241 },
  "PSQ66410.1": { gly: 158, lys: 241 },
  "PSQ94898.1": { gly: 158, lys: 242 },
  "PSQ65031.1": { gly: 158, lys: 241 },
  "PQJ33473.1": { gly: 158, lys: 241 },
  "PSQ95756.1": { gly: 158, lys: 241 },
  "PJF35373.1": { gly: 149, lys: 231 },
  "ANE44876.1": { gly: 168, lys: 247 },
  "OZ252009.1": { gly: 176, lys: 255 },
  "GGR19346.1": { gly: 171, lys: 250 },
  "GGJ70114.1": { gly: 171, lys: 250 },
  "OZ252036.1": { gly: 171, lys: 250 },
  "RZM77228.1": { gly: 158, lys: 237 },
  "TVP63961.1": { gly: 158, lys: 237 },
  "ESA36503.1": { gly: 158, lys: 237 },
};
let filteredProteins = proteins;
    let currentIndex = 0;
    let viewer;
    const tooltip = document.getElementById('tooltip');

    // base style shown at all times
    const baseStyle = { cartoon: { color: 'gray' } };
    // highlight style for hovered residue
    const highlightStyle = { stick: { color: 'red', radius: 0.45 } };

    function getPageXY(evt){
      const x = (evt && (evt.pageX || (evt.clientX + window.scrollX))) || 0;
      const y = (evt && (evt.pageY || (evt.clientY + window.scrollY))) || 0;
      return [x,y];
    }

    function init() {
      viewer = $3Dmol.createViewer("viewer", { backgroundColor: "white" });
      createClusterButtons();
      if (proteins.length) loadProtein(0);
    }

    function loadProtein(index) {
      currentIndex = index;
      const entry = filteredProteins[index];
      if (!entry) return;

      const ext = entry.format === "cif" ? "cif" : "pdb";
      const filePath = `models/${entry.id}.${ext}`;

      viewer.clear();
      tooltip.style.display = 'none';

      $3Dmol.download(filePath, viewer, { format: ext }, function() {

        // default gray
        viewer.setStyle({}, baseStyle);

        // special references green
        if(entry.id === "ABC44767.1" || entry.id === "Kin4B8") {
          viewer.setStyle({}, { cartoon: { color: 'green' } });
        }

        // conserved residues blue
        if(conservedResidues[entry.id]) {
          const res = conservedResidues[entry.id];
          viewer.addStyle({resi: res.gly}, {cartoon:{color:'blue'}});
          viewer.addStyle({resi: res.lys}, {cartoon:{color:'blue'}});
        }


        // enable atom picking over the whole model (works even with only cartoon drawn)
        viewer.setHoverable({}, true,
          // hover in
          function(atom, v, event, container) {
            if (!atom) return;
            const [px, py] = getPageXY(event);
            tooltip.style.display = 'block';
            tooltip.style.left = (px + 12) + 'px';
            tooltip.style.top  = (py + 12) + 'px';
            tooltip.innerHTML  = `${atom.resn} ${atom.resi} (Chain ${atom.chain}) — ${atom.atom}`;

            // redraw: base + highlight current residue
            v.setStyle({}, baseStyle);
            v.addStyle({resi: atom.resi, chain: atom.chain}, highlightStyle);
            v.render();
          },
          // hover out
          function(atom, v) {
            tooltip.style.display = 'none';
            v.setStyle({}, baseStyle);
            v.render();
          }
        );

        viewer.zoomTo();
        viewer.render();
      });

      // update meta
      document.getElementById("meta-id").innerText = entry.id;
      document.getElementById("meta-cluster").innerText = entry.cluster;
      document.getElementById("meta-type").innerText = entry.experimental ? "Experimental" : "Predicted";
    }

    function createClusterButtons() {
      const container = document.getElementById("clusterButtons");
      container.innerHTML = "";
      const clusters = [...new Set(proteins.map(p => p.cluster))].sort((a,b)=>a-b);

      clusters.forEach(cluster => {
        const btn = document.createElement("button");
        btn.textContent = cluster;
        btn.onclick = () => { filteredProteins = proteins.filter(p => p.cluster === cluster); loadProtein(0); };
        container.appendChild(btn);
      });

      const allBtn = document.createElement("button");
      allBtn.textContent = "All";
      allBtn.onclick = () => { filteredProteins = proteins; loadProtein(0); };
      container.insertBefore(allBtn, container.firstChild);
    }

    document.getElementById("prevBtn").onclick = () => {
      if (!filteredProteins.length) return;
      const newIndex = (currentIndex - 1 + filteredProteins.length) % filteredProteins.length;
      loadProtein(newIndex);
    };

    document.getElementById("nextBtn").onclick = () => {
      if (!filteredProteins.length) return;
      const newIndex = (currentIndex + 1) % filteredProteins.length;
      loadProtein(newIndex);
    };

    document.getElementById("searchBtn").onclick = () => {
      const q = document.getElementById("searchBox").value.toLowerCase();
      const idx = proteins.findIndex(p => p.id.toLowerCase().includes(q) || String(p.cluster).toLowerCase().includes(q));
      if (idx !== -1) { filteredProteins = proteins; loadProtein(idx); }
      else alert("No match found");
    };

    window.onload = init;
  </script>
</body>
</html>
